"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const schemaAccess_1 = require("../../specification/schemaAccess");
const common_1 = require("../../specification/common");
const generate_1 = require("../v2/generate");
const ovpProvider_1 = require("../v2/import/app/ovpProvider");
const appProvider_1 = require("../v2/import/app/appProvider");
const appProvider_2 = require("../v4/import/app/appProvider");
const utils_1 = require("./utils");
const types_1 = require("./types");
const generate_2 = require("../v4/generate");
async function getGenericSchemas(fioriElementsVersion) {
    const genericSchemas = {};
    let schemaTypes = [];
    if (fioriElementsVersion === common_1.FioriElementsVersion.v2) {
        schemaTypes = [
            common_1.SchemaType.Application,
            common_1.SchemaType.ListReport,
            common_1.SchemaType.ObjectPage,
            common_1.SchemaType.OverviewPage,
            common_1.SchemaType.AnalyticalListPage
        ];
    }
    if (fioriElementsVersion === common_1.FioriElementsVersion.v4) {
        schemaTypes = [common_1.SchemaType.Application, common_1.SchemaType.ListReport, common_1.SchemaType.ObjectPage];
    }
    for (const schemaType of schemaTypes) {
        genericSchemas[schemaType] = await schemaAccess_1.getGenericSchema(fioriElementsVersion, schemaType);
    }
    return genericSchemas;
}
/**
 * Get the relavant UI.ListItem and UI.Facet entity sets
 * @param entityTypes - array of entity types, parsed, merged, and converted by AVT
 */
function getAnnotationsForUi(entityTypes) {
    const entitySets = {
        Facets: [],
        LineItems: []
    };
    for (const entity of entityTypes) {
        if (!entity.annotations || !entity.annotations.UI) {
            continue;
        }
        const name = entity.name || entity.fullyQualifiedName.split('.').pop();
        const { LineItem, Facets } = entity.annotations.UI;
        if (LineItem &&
            !LineItem.qualifier &&
            LineItem.find((li) => li.$Type === 'com.sap.vocabularies.UI.v1.DataField' ||
                li.$Type === 'com.sap.vocabularies.UI.v1.DataFieldForAnnotation')) {
            entitySets.LineItems.push(name);
        }
        if (Facets && !Facets.qualifier) {
            entitySets.Facets.push(name);
        }
    }
    return entitySets;
}
function generateSchemasV2(genericSchemas, uiEntityTypes, entityTypes, manifest) {
    const schemas = {};
    for (const entitySet of uiEntityTypes.Facets) {
        // ObjectPage
        schemas[`${common_1.SchemaType.ObjectPage}_${entitySet}`] = generate_1.generateObjectPageSchemaV2(genericSchemas[common_1.SchemaType.ObjectPage], entitySet, entityTypes, manifest);
    }
    for (const entitySet of uiEntityTypes.LineItems) {
        // ListReport
        schemas[`${common_1.SchemaType.ListReport}_${entitySet}`] = generate_1.generateListReportSchemaV2(genericSchemas[common_1.SchemaType.ListReport], entitySet, entityTypes);
    }
    return { ...genericSchemas, ...schemas };
}
function generateSchemasV4(genericSchemas, uiEntityTypes, entityTypes, manifest) {
    const schemas = {};
    for (const entitySet of uiEntityTypes.Facets) {
        // ObjectPage
        schemas[`${common_1.SchemaType.ObjectPage}_${entitySet}`] = generate_2.generateObjectPageSchemaV4(genericSchemas[common_1.SchemaType.ObjectPage], entitySet, entityTypes, manifest);
    }
    for (const entitySet of uiEntityTypes.LineItems) {
        // ListReport
        schemas[`${common_1.SchemaType.ListReport}_${entitySet}`] = generate_2.generateListReportSchemaV4(genericSchemas[common_1.SchemaType.ListReport]);
    }
    return { ...genericSchemas, ...schemas };
}
async function generateSchemas(uiEntityTypes, fioriElementsVersion, entityTypes, manifest) {
    const genericSchemas = await getGenericSchemas(fioriElementsVersion);
    if (fioriElementsVersion === common_1.FioriElementsVersion.v4) {
        return generateSchemasV4(genericSchemas, uiEntityTypes, entityTypes, manifest);
    }
    else {
        return generateSchemasV2(genericSchemas, uiEntityTypes, entityTypes, manifest);
    }
}
function importConfigs(manifest, flex, schemas) {
    let provider;
    const files = [];
    if (manifest['sap.ovp']) {
        provider = new ovpProvider_1.V2OvpProvider(manifest, schemas);
    }
    else if (manifest['sap.ui.generic.app']) {
        provider = new appProvider_1.V2AppProvider(manifest, flex, schemas);
    }
    else {
        provider = new appProvider_2.V4AppProvider(manifest, schemas);
    }
    if (provider) {
        const { appConfig, pageConfigs } = provider.createConfigFiles();
        for (const app in appConfig) {
            files.push({ dataSourceUri: app, fileContent: JSON.stringify(appConfig[app], null, 4) });
        }
        for (const config in pageConfigs) {
            files.push({ dataSourceUri: config, fileContent: JSON.stringify(pageConfigs[config], null, 4) });
        }
    }
    return files;
}
function getFileList(schema, configs) {
    let files = [];
    for (const schemaName of Object.keys(schema).sort()) {
        let dataSourceUri;
        if (schemaName === common_1.SchemaType.Application) {
            dataSourceUri = `${types_1.DirName.Schemas}/${types_1.FileName.App[0].toUpperCase()}${types_1.FileName.App.slice(1)}`;
        }
        else {
            dataSourceUri = `${types_1.DirName.Schemas}/${schemaName}.json`;
        }
        files.push({ dataSourceUri, fileContent: JSON.stringify(schema[schemaName], null, 4) });
    }
    files = files.concat(configs);
    return files;
}
/**
 * Import the schema and config files for a given project
 * @param importParameters - files of the project: manifest, flex changes, odata files
 */
async function importProjectSchemaAndConfig(importProjectParameters) {
    let files = [];
    const { manifest, annotations, flex } = importProjectParameters;
    const fioriElementsVersion = utils_1.getVersionFromManifest(manifest);
    const entityTypes = utils_1.parseAndMergeAndConvert(annotations);
    const uiEntityTypes = getAnnotationsForUi(entityTypes);
    const schemas = await generateSchemas(uiEntityTypes, fioriElementsVersion, entityTypes, manifest);
    const configFiles = importConfigs(manifest, flex, schemas);
    files = getFileList(schemas, configFiles);
    return files;
}
exports.importProjectSchemaAndConfig = importProjectSchemaAndConfig;
//# sourceMappingURL=importProject.js.map